<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Helper de Receitas ‚Äî Otimizado</title>
<style>
  :root{
    --mid-bg: #2e231f;
    --left-bg: #4b3a33;
    --right-bg: #6b564c;
    --text: #f4f4f4;
    --accent: #ffcc00;
    --muted: #bfb0a6;
  }
  body{
    margin:0;
    height:100vh;
    display:flex;
    font-family: Arial, sans-serif;
    background: var(--left-bg);
    color: var(--text);
  }

  /* esquerda - lista de receitas */
  #lista-receitas {
    flex: 1;
    background: var(--left-bg);
    overflow-y:auto;
    padding: 12px;
    box-sizing: border-box;
  }
  .receita-item {
    display:flex;
    gap:10px;
    align-items:center;
    padding:8px;
    border-bottom:1px solid rgba(0,0,0,0.12);
    cursor:pointer;
  }
  .receita-item img { width:44px; height:44px; object-fit:contain; background:transparent; border-radius:6px; }

  .receita-nome { font-weight:700; }
  .receita-meta { font-size:13px; color: var(--muted); margin-left:54px; margin-top:-6px; }

  /* meio - detalhes */
  #detalhes {
    flex: 2;
    background: var(--mid-bg);
    padding: 14px;
    box-sizing: border-box;
    overflow-y:auto;
  }
  #nome-receita { margin:0 0 4px 0; font-size:20px; }
  #meta-receita { margin:10 0 0px 0; font-size:13px; color: var(--muted); }

  .ingrediente {
    background: rgba(255,255,255,0.03);
    padding:8px;
    border-radius:6px;
    margin-bottom:8px;
  }

  .ingrediente-top {
    display:flex;
    align-items:center;
    gap:10px;
  }
  .ingrediente-top img { width:32px; height:32px; object-fit:contain; background:transparent; border-radius:4px; }

  .qtd-base { color:var(--muted); margin-right:6px; }
  .nome { font-weight:700; color:var(--text); margin-right:8px; }

  .qtd-desejada {
    color: var(--accent);
    font-weight:700;
    font-size:1.05em;
    margin-left:auto;
  }

  .ingrediente-valores {
    font-size:13px;
    color: var(--muted);
    margin-left:46px;
    margin-top:6px;
  }

  /* direita - painel */
  #painel {
    flex: 1;
    background: var(--right-bg);
    padding:12px;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .painel-box {
    background: rgba(0,0,0,0.05);
    padding:10px;
    border-radius:8px;
    color: var(--text);
  }
  input[type="number"]{ width:100%; padding:8px; border-radius:6px; border: none; outline:none; font-size:14px; }

  .small-muted { color: var(--muted); font-size:13px; }

  /* responsivo simples */
  @media(max-width:900px){
    body { flex-direction: column; height: auto; }
    #lista-receitas, #detalhes, #painel { width:100%; }
    .receita-meta { margin-left:0; margin-top:4px; }
    .qtd-desejada { margin-left:8px; }
    .ingrediente-valores { margin-left:42px; }
  }
</style>
</head>
<body>

  <div id="lista-receitas" aria-label="Lista de receitas"></div>

  <div id="detalhes">
    <h2 id="nome-receita">Selecione uma receita</h2>
    <p id="meta-receita" class="small-muted"></p>
    <div id="ingredientes-lista"></div>
  </div>

  <div id="painel" aria-label="Painel de c√°lculos">
    <div class="painel-box small-muted">
     üì¶ Quantidade (1‚Äì100)
      <input type="number" id="qtd" min="1" max="100" value="1">
    </div>

    <div class="painel-box small-muted">
     ‚öôÔ∏è Custo unit√°rio (1 unidade): <strong id="custo-unit">…É 0</strong>
    </div>

    <div class="painel-box small-muted">
     üßÆ Custo total: <strong id="custo-total">…É 0</strong>
    </div>

    <div class="painel-box small-muted">
     üí∞ Pre√ßo de venda (por unidade)
      <input type="number" id="preco-venda" value="0" step="0.01" min="0">
    </div>

    <div class="painel-box small-muted">
     ü§ë Lucro: <strong id="lucro">…É 0</strong>
    </div>
  </div>

<script>
/* ===== util ===== */
const FMT = new Intl.NumberFormat('pt-BR');
const MON = '…É';
const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
function money(n){ n = Number(n)||0; return MON + ' ' + FMT.format(Math.round(n)); }

/* ===== dados ===== */
let itens = [];
let itensById = new Map();
let receitas = [];
let receitaSelecionada = null;

/* ===== cache de sprites (carrega uma vez e reaproveita) ===== */
const spriteCache = new Map(); // url -> Promise<string (objectURL|dataURL)>
async function getSpriteURL(url){
  if(!url) return '';
  if(spriteCache.has(url)) return spriteCache.get(url);
  const p = fetch(url)
    .then(r => { if(!r.ok) throw new Error('HTTP'); return r.blob(); })
    .then(blob => URL.createObjectURL(blob))
    .catch(() => '');
  spriteCache.set(url, p);
  return p;
}
function setImg(imgEl, url){
  if(!url){ imgEl.src=''; imgEl.style.background='#887'; return; }
  getSpriteURL(url).then(src => {
    if(src){ imgEl.src = src; imgEl.style.background='transparent'; }
    else { imgEl.src=''; imgEl.style.background='#887'; }
  });
}

/* ===== refs din√¢micos para atualiza√ß√£o sem recriar elementos ===== */
let ingredienteNodes = []; // [{ qtdBase, valorUnit, qtdDesejadaEl, valoresEl, valoresPrefix }]
let custoUnitAtual = 0;

/* ===== carregar dados ===== */
async function carregar(){
  try{
    const r1 = await fetch('itens.json');
    if(!r1.ok) throw new Error('itens.json n√£o encontrado / erro HTTP');
    itens = await r1.json();
    itensById = new Map(itens.map(it => [Number(it.id), it]));

    const r2 = await fetch('receitas.json');
    if(!r2.ok) throw new Error('receitas.json n√£o encontrado / erro HTTP');
    receitas = await r2.json();

    montarListaReceitas();
  }catch(err){
    alert('Erro ao carregar arquivos: ' + err.message + '\nVer console para mais detalhes.');
    console.error(err);
  }
}

/* ===== lista esquerda: inclui n√≠vel e cooldown ===== */
function montarListaReceitas(){
  const lista = document.getElementById('lista-receitas');
  lista.innerHTML = '';
  receitas.forEach((r) => {
    const item = document.createElement('div');
    item.className = 'receita-item';

    const img = document.createElement('img');
    img.alt = r.nome || 'Sprite da receita';
    setImg(img, r.sprite);

    const txt = document.createElement('div');
    const nivel = (r.level ?? '‚Äî');
    const cd = (r.cooldown ?? '‚Äî');
    txt.innerHTML = `
      <div class="receita-nome">${r.nome}</div>
      <div class="receita-meta">N√≠vel ${nivel} ‚Äî ${cd}s</div>
    `;

    item.appendChild(img);
    item.appendChild(txt);
    item.onclick = () => selecionarReceita(r);
    lista.appendChild(item);
  });
}

/* ===== construir ingredientes uma vez por sele√ß√£o ===== */
function construirIngredientes(r){
  const box = document.getElementById('ingredientes-lista');
  box.innerHTML = '';
  ingredienteNodes = [];
  custoUnitAtual = 0;

  r.ingredientes.forEach(ing => {
    const it = itensById.get(Number(ing.id));
    const valorUnit = it ? Number(it.valor)||0 : 0;
    const qtdBase = Number(ing.quantidade)||0;

    // container
    const div = document.createElement('div');
    div.className = 'ingrediente';

    // linha topo
    const top = document.createElement('div');
    top.className = 'ingrediente-top';

    const img = document.createElement('img');
    img.alt = it ? it.nome : `Item id ${ing.id}`;
    setImg(img, it && it.sprite ? it.sprite : '');

    const qtdBaseSpan = document.createElement('span');
    qtdBaseSpan.className = 'qtd-base';
    qtdBaseSpan.textContent = `(${qtdBase})`;

    const nomeSpan = document.createElement('span');
    nomeSpan.className = 'nome';
    nomeSpan.textContent = it ? it.nome : `Item id ${ing.id} n√£o encontrado`;

    const qtdDesejadaSpan = document.createElement('span');
    qtdDesejadaSpan.className = 'qtd-desejada';
    // valor ser√° preenchido no update

    top.appendChild(img);
    top.appendChild(qtdBaseSpan);
    top.appendChild(nomeSpan);
    top.appendChild(qtdDesejadaSpan);

    // linha valores
    const bottom = document.createElement('div');
    bottom.className = 'ingrediente-valores';
    const valoresPrefix = `${MON} ${FMT.format(valorUnit)} = `;
    // sufixo (total) ser√° preenchido no update

    div.appendChild(top);
    div.appendChild(bottom);
    box.appendChild(div);

    ingredienteNodes.push({
      qtdBase,
      valorUnit,
      qtdDesejadaEl: qtdDesejadaSpan,
      valoresEl: bottom,
      valoresPrefix
    });

    custoUnitAtual += valorUnit * qtdBase;
  });
}

/* ===== atualizar apenas n√∫meros ===== */
function atualizarNumeros(){
  if(!receitaSelecionada) return;

  // quantidade
  const qtdInput = document.getElementById('qtd');
  const q = clamp(Number(qtdInput.value)||1, Number(qtdInput.min)||1, Number(qtdInput.max)||100);
  if(q !== Number(qtdInput.value)) qtdInput.value = q;

  // pre√ßo venda unit
  const precoUnit = Number(document.getElementById('preco-venda').value) || 0;

  // atualizar linhas de ingredientes
  for(const node of ingredienteNodes){
    const qtdTotal = node.qtdBase * q;
    node.qtdDesejadaEl.textContent = qtdTotal;
    const total = Math.round(node.valorUnit * qtdTotal);
    node.valoresEl.textContent = `${node.valoresPrefix}${MON} ${FMT.format(total)}`;
  }

  // painel custos e lucro
  const custoUnit = Math.round(custoUnitAtual);
  const custoTotal = Math.round(custoUnitAtual * q);
  document.getElementById('custo-unit').textContent = `${MON} ${FMT.format(custoUnit)}`;
  document.getElementById('custo-total').textContent = `${MON} ${FMT.format(custoTotal)}`;

  const receitaBruta = precoUnit * q;
  const taxa = receitaBruta * 0.03; // 3% de taxa
  const lucro = receitaBruta - taxa - (custoUnitAtual * q);

  document.getElementById('lucro').textContent = `${MON} ${FMT.format(lucro)}`;
}

/* ===== selecionar receita ===== */
function selecionarReceita(r){
  receitaSelecionada = r;
  document.getElementById('nome-receita').textContent = r.nome || 'Receita';
  const nivel = (r.level ?? '‚Äî');
  const cd = (r.cooldown ?? '‚Äî');
  document.getElementById('meta-receita').textContent = `N√≠vel ${nivel} ‚Äî ${cd}s`;
  construirIngredientes(r);
  atualizarNumeros();
}

/* ===== listeners ===== */
document.getElementById('qtd').addEventListener('input', atualizarNumeros);
document.getElementById('preco-venda').addEventListener('input', atualizarNumeros);

/* ===== start ===== */
carregar();
</script>

</body>
</html>
